#!/usr/bin/env python3
"""
oe-setup-vscode - Set up VS Code configuration for OpenEmbedded/Yocto development.

Usage: oe-setup-vscode <OEINIT> <BUILDDIR> [<BUILDDIR2> ...]
  OEINIT:   path to directory where the .vscode folder is
  BUILDDIR: directory passed to the oe-init-build-env script (one or more)

The script enforces the canonical exclude configuration on every run while
preserving any additional user settings already present in the file.
"""

import json
import os
import re
import sys


def usage():
    print(f"Usage: {sys.argv[0]} <OEINIT> <BUILDDIR> [<BUILDDIR2> ...]")
    print("  OEINIT:   path to directory where the .vscode folder is")
    print("  BUILDDIR: directory passed to the oe-init-build-env script")


def strip_jsonc(content):
    """Remove JSONC comments and trailing commas, string-aware."""
    result = []
    i = 0
    n = len(content)
    in_string = False
    while i < n:
        c = content[i]
        if in_string:
            if c == '\\' and i + 1 < n:
                result.append(c)
                result.append(content[i + 1])
                i += 2
            elif c == '"':
                result.append(c)
                in_string = False
                i += 1
            else:
                result.append(c)
                i += 1
        else:
            if c == '"':
                result.append(c)
                in_string = True
                i += 1
            elif c == '/' and i + 1 < n and content[i + 1] == '/':
                # Line comment — skip to end of line
                while i < n and content[i] != '\n':
                    i += 1
            elif c == '/' and i + 1 < n and content[i + 1] == '*':
                # Block comment — skip to */
                i += 2
                while i < n - 1 and not (content[i] == '*' and content[i + 1] == '/'):
                    i += 1
                i += 2
            else:
                result.append(c)
                i += 1
    cleaned = ''.join(result)
    # Strip trailing commas before } or ] (allowed in JSONC, not in JSON)
    cleaned = re.sub(r',(\s*[}\]])', r'\1', cleaned)
    return cleaned


def load_jsonc(path):
    """Load a JSON/JSONC file, handling comments and trailing commas."""
    with open(path) as f:
        content = f.read()
    return json.loads(strip_jsonc(content))


def merge_obj(existing, canonical):
    """Enforce canonical keys in an object, preserving any extra user keys."""
    merged = {k: v for k, v in existing.items() if k not in canonical}
    merged.update(canonical)
    return merged


def merge_list(existing, canonical):
    """Enforce canonical entries in a list, appending any extra user entries."""
    canonical_set = set(canonical)
    extra = [x for x in existing if x not in canonical_set]
    return list(canonical) + extra


# ---------------------------------------------------------------------------
# Canonical managed values
# ---------------------------------------------------------------------------

# Keys that are always overwritten to their canonical scalar/list value.
# (exclude sections are handled separately via merge so user additions survive)
CANONICAL_SCALAR_KEYS = [
    "bitbake.buildConfigurations",   # computed from CLI args
    "bitbake.disableConfigModification",
    "bitbake.pathToEnvScript",
    "bitbake.pathToBitbakeFolder",
    "bitbake.parseOnSave",
    "git.detectSubmodulesLimit",
]

# files.exclude: paths hidden from the explorer navigator AND search.
# Keep this small — only truly non-source content that has no value being
# visible in the file tree.
CANONICAL_FILES_EXCLUDE = {
    "**/.git/**": True,
    "**/cache/**": True,
    "**/downloads/**": True,
    "**/node_modules/**": True,
    "**/sstate-cache/**": True,
    "**/workspace/attic/**": True,
}

# search.exclude: visible in the navigator but not indexed by search.
CANONICAL_SEARCH_EXCLUDE = {
    "**/.git/**": True,
    "**/bitbake-cookerdaemon.log": True,
    "**/buildhistory/**": True,
    "**/cache/**": True,
    "**/downloads/**": True,
    "**/node_modules/**": True,
    "**/oe-logs/**": True,
    "**/oe-workdir/**": True,
    "**/sstate-cache/**": True,
    "**/tmp*/**": True,
    "**/workspace/attic/**": True,
    "**/workspace/sources/**": True,
}

# files.watcherExclude: not watched by the file-system watcher (performance).
CANONICAL_WATCHER_EXCLUDE = {
    "**/.git/**": True,
    "**/buildhistory/**": True,
    "**/cache/**": True,
    "**/downloads/**": True,
    "**/node_modules/**": True,
    "**/oe-logs/**": True,
    "**/oe-workdir/**": True,
    "**/sstate-cache/**": True,
    "**/tmp*/**": True,
    "**/workspace/attic/**": True,
    "**/workspace/sources/**": True,
}

# python.analysis.exclude: not indexed by Pylance.
CANONICAL_PYTHON_EXCLUDE = [
    "**/.git/**",
    "**/buildhistory/**",
    "**/cache/**",
    "**/downloads/**",
    "**/node_modules/**",
    "**/oe-logs/**",
    "**/oe-workdir/**",
    "**/sstate-cache/**",
    "**/tmp*/**",
    "**/workspace/attic/**",
    "**/workspace/sources/**",
]

CANONICAL_RECOMMENDATIONS = [
    "editorconfig.editorconfig",
    "yocto-project.yocto-bitbake",
]


def main():
    if len(sys.argv) < 3:
        usage()
        sys.exit(1)

    oeinit = os.path.realpath(sys.argv[1])
    builddir_args = sys.argv[2:]
    vscodedir = os.path.join(oeinit, ".vscode")

    if not os.path.isdir(oeinit):
        print(f"Error: {oeinit} directory is not present.")
        sys.exit(1)

    # De-duplicate build dirs, preserving order
    bdirs = []
    seen = set()
    for arg in builddir_args:
        canonical = os.path.realpath(arg)
        if canonical not in seen and os.path.isdir(canonical):
            seen.add(canonical)
            bdirs.append(canonical)

    # Build configurations (only dirs that look like OE build dirs)
    build_configurations = []
    for bdir in bdirs:
        if os.path.exists(os.path.join(bdir, "conf", "bblayers.conf")):
            ws_builddir = bdir.replace(oeinit, "${workspaceFolder}")
            build_configurations.append({
                "name": os.path.basename(bdir),
                "pathToBuildFolder": ws_builddir,
            })

    os.makedirs(vscodedir, exist_ok=True)

    # ------------------------------------------------------------------
    # settings.json
    # ------------------------------------------------------------------
    settings_path = os.path.join(vscodedir, "settings.json")
    existing = {}
    is_new = True
    if os.path.exists(settings_path):
        try:
            existing = load_jsonc(settings_path)
            is_new = False
        except (json.JSONDecodeError, OSError) as e:
            print(f"Warning: could not parse existing {settings_path}: {e}")
            print("It will be overwritten with a fresh configuration.")

    # Build output: canonical keys first (in defined order), then any extra
    # user keys that are not managed by this script.
    settings = {}

    # Scalar / list keys — always overwritten
    settings["bitbake.buildConfigurations"] = build_configurations
    settings["bitbake.disableConfigModification"] = True
    settings["bitbake.pathToEnvScript"] = "${workspaceFolder}/oe-init-build-env"
    settings["bitbake.pathToBitbakeFolder"] = "${workspaceFolder}/layers/bitbake"
    settings["bitbake.parseOnSave"] = False
    settings["git.detectSubmodulesLimit"] = 10

    # Exclude sections — enforced but merged with user additions
    settings["files.exclude"] = merge_obj(
        existing.get("files.exclude", {}), CANONICAL_FILES_EXCLUDE
    )
    settings["search.exclude"] = merge_obj(
        existing.get("search.exclude", {}), CANONICAL_SEARCH_EXCLUDE
    )
    settings["files.watcherExclude"] = merge_obj(
        existing.get("files.watcherExclude", {}), CANONICAL_WATCHER_EXCLUDE
    )
    settings["python.analysis.exclude"] = merge_list(
        existing.get("python.analysis.exclude", []), CANONICAL_PYTHON_EXCLUDE
    )

    # Preserve any other user-defined keys
    managed = set(CANONICAL_SCALAR_KEYS) | {
        "files.exclude", "search.exclude",
        "files.watcherExclude", "python.analysis.exclude",
    }
    for k, v in existing.items():
        if k not in managed:
            settings[k] = v

    with open(settings_path, "w") as f:
        json.dump(settings, f, indent=4)
        f.write("\n")

    # ------------------------------------------------------------------
    # extensions.json
    # ------------------------------------------------------------------
    extensions_path = os.path.join(vscodedir, "extensions.json")
    existing_ext = {}
    if os.path.exists(extensions_path):
        try:
            existing_ext = load_jsonc(extensions_path)
        except (json.JSONDecodeError, OSError):
            pass

    extensions = dict(existing_ext)
    extensions["recommendations"] = merge_list(
        existing_ext.get("recommendations", []), CANONICAL_RECOMMENDATIONS
    )

    with open(extensions_path, "w") as f:
        json.dump(extensions, f, indent=4)
        f.write("\n")

    if is_new:
        print(f"You had no {vscodedir} configuration.")
        print("These configuration files have therefore been created for you.")
    else:
        print(f"VS Code configuration in {vscodedir} has been updated.")


if __name__ == "__main__":
    main()
